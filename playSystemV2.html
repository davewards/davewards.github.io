<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Badminton Play Schedule</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <style>
        .container {
        margin-top: 50px;
      }
      .hover:hover {
        cursor: pointer;
      }
      /* The switch - the box around the slider */
      .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }

      /* Hide default HTML checkbox */
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      /* The slider */
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
      }

      input:checked + .slider {
        background-color: #2196F3;
      }

      input:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
      }

      input:checked + .slider:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(26px);
      }

      /* Rounded sliders */
      .slider.round {
        border-radius: 34px;
      }

      .slider.round:before {
        border-radius: 50%;
      }
    </style>
</head>

<body style="max-width: 90vw; margin-left:8px">
    <h2>Court Scheduler V2</h2>
        <div class="row align-items-start" style="min-height: 150px;">
            <div style="border: 1px solid lightgrey; min-height: 130px;" class="col-sm-12 col-md-3" id="court1">
                <h3>Court 1</h3>
                <hr>
                <div class="row">
                    <div id="player1"></div>
                    <div id="player2"></div>
                </div>
                <div class="row">
                    <div id="player3"></div>
                    <div id="player4"></div>
                </div>
            </div>
            <div style="border: 1px solid lightgrey; min-height: 130px;" class="col-sm-12 col-md-3" id="court2">
                <h3>Court 2</h3>
                <hr>
                <div class="row">
                    <div id="player5"></div>
                    <div id="player6"></div>
                </div>
                <div class="row">
                    <div id="player7"></div>
                    <div id="player8"></div>
                </div>
            </div>
            <div style="border: 1px solid lightgrey; min-height: 130px;" class="col-sm-12 col-md-3" id="court3">
                <h3>Court 3</h3>
                <hr>
                <div class="row">
                    <div id="player9"></div>
                    <div id="player10"></div>
                </div>
                <div class="row">
                    <div id="player11"></div>
                    <div id="player12"></div>
                </div>
            </div>
            <div style="border: 1px solid lightgrey; min-height: 130px;" class="col-sm-12 col-md-3" id="court4">
                <h3>Court 4</h3>
                <hr>
                <div class="row">
                    <div id="player13"></div>
                    <div id="player14"></div>
                </div>
                <div class="row">
                    <div id="player15"></div>
                    <div id="player16"></div>
                </div>
            </div>
            <div style="border: 1px solid lightgrey; min-height: 130px;" class="col-sm-12 col-md-3" id="court5">
                <h3>Court 5</h3>
                <hr>
                <div class="row">
                    <div id="player17"></div>
                    <div id="player18"></div>
                </div>
                <div class="row">
                    <div id="player19"></div>
                    <div id="player20"></div>
                </div>
            </div>
            <div style="border: 1px solid lightgrey; min-height: 130px;" class="col-sm-12 col-md-3" id="court6">
                <h3>Court 6</h3>
                <hr>
                <div class="row">
                    <div id="player21"></div>
                    <div id="player22"></div>
                </div>
                <div class="row">
                    <div id="player23"></div>
                    <div id="player24"></div>
                </div>
            </div>
            <div style="border: 1px solid lightgrey; min-height: 130px;" class="col-sm-12 col-md-3" id="court7">
                <h3>Court 7</h3>
                <hr>
                <div class="row">
                    <div id="player25"></div>
                    <div id="player26"></div>
                </div>
                <div class="row">
                    <div id="player27"></div>
                    <div id="player28"></div>
                </div>
            </div>
            <div style="border: 1px solid lightgrey; min-height: 130px;" class="col-sm-12 col-md-3" id="court8">
                <h3>Court 8</h3>
                <hr>
                <div class="row">
                    <div id="player29"></div>
                    <div id="player30"></div>
                </div>
                <div class="row">
                    <div id="player31"></div>
                    <div id="player32"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <button id="newGame" onclick="setGames()" style="background-color: #7ba1ea;" class=" col-sm-12 col-md-4 mt-4 mb-4">Next Game</button>
            <button id="newGame" onclick="clearPlayers()" style="background-color: #7bc1ea;" class=" col-sm-12 col-md-4 mt-4 mb-4 float-right">Clear Players</button>
            <button id="newGame" onclick="resetPlayers()" style="background-color: #61ad71;" class=" col-sm-12 col-md-4 mt-4 mb-4 float-right">Reset Players</button>
        </div>
        <div class="row align-items-start">
            <div class="col-sm-12 col-md-4 pl-4 float-left">
                <label>How many courts do you have? (max 8)</label>
                <input type="number" class="form-control" id="courtsAvailable" name="" min="1" max="8" value="4" placeholder="How many courts have you got?">
            </div>
            <div class="col-sm-12 col-md-4 pl-4 float-left text-left">
                <label>Upload player file (data is local only)</label>
                <input type="file" class="form-control" id="csv" name="googleSheetURL" placeholder="Load local CSV file">
                <label style="text-align: left;">File format expected: <b>CSV</b>. <br>Two columns: Name, Division. Eg. <br>Player One,4<br>Player Two,6</label>
            </div>
            <div class="col-sm-12 col-md-4 pl-4 float-left">
                <label>Player Mode</label><br />
                <label>Random</label>
                <!-- <input type="checkbox" class="form-check-input" id="graded" name="graded" placeholder=""> -->
                <label class="switch">
                    <input type="checkbox" id="graded">
                    <span class="slider"></span>
                </label>
                <label>Graded</label>
            </div>
        </div>
        <hr>
        <form id="playerInputForm">
            <div class="row">
                <h4 id="formWarning" style="text-align: left; padding-top: 5px"></h4>
            </div>
            <div class="row align-items-start">
                <div class="col-sm-12 col-md-4 pl-4 float-left">
                    <input type="string" class="form-control" id="newPlayer" name="newPlayer" placeholder="Type name">
                </div>
                <div class="col-sm-12 col-md-4 pl-4 float-left">
                    <input type="number" class="form-control" id="newPlayerDivision" name="newPlayerDivision" placeholder="Type division">
                </div>
                <div class="col-sm-12 col-md-4 pl-4 float-left">
                    <button id="submitPlayer" class="form-control">Add Player</button>
                </div>
            </div>
        </form>
        <div class="row align-items-start" style="margin-top: 30px">
            <h3>Present</h3>
            <table class="table" id="playerTable">
                <thead>
                    <th>Attending</th>
                    <th>Name</th>
                    <th>Games Played</th>
                    <th>Games Won</th>
                    <th>Division</th>
                    <th>Status</th>
                </thead>
                <tbody id="tableRowsAttending">
                </tbody>
            </table>
        </div>
        <div class="row align-items-start" style="margin-top: 30px">
            <h3>Not Present</h3>
            <table class="table" id="playerTable">
                <thead>
                    <th>Attending</th>
                    <th>Name</th>
                    <th>Games Played</th>
                    <th>Division</th>
                    <th>Status</th>
                </thead>
                <tbody id="tableRows">
                </tbody>
            </table>
        </div>
    
    <script>
    let players = [];
    let captained = {};

    setTable(players)

    function resetPlayers() {
        players = players.map(player => {
            player[3] = 'Waiting'
            player[2] = 0
            player[5] = {}
            return player;
        })
        captained = {}
        window.localStorage.setItem('players', JSON.stringify(players))
        setTable()
        setGames()
    }

    function clearPlayers() {
        players = []
        setTable()
        setGames()
    }

    function comparePlayCounts(a, b) {
        return a[2] - b[2] || Math.random() - Math.random();
    }

    function comparePlayerNames(a, b) {
        return a[0] - b[0];
    }

    function compareDivisions(a, b) {
        return a[1] - b[1] || a[2] - b[2] || Math.random() - Math.random();
    }

    function setPlayersPlayed(player, availablePlayers) {
        for (let otherPlayer of availablePlayers) {
            if (otherPlayer[0] !== player[0]) {
                player[5][otherPlayer[0]] = otherPlayer[0] in player[5] ? player[5][otherPlayer[0]] : 0
            }
        }
        return player
    }

    function setCaptains() {
        players.filter(player => player[4]).map(player => {
            captained[player[0]] = player[0] in captained ? captained[player[0]] : 0
        })
    }

    function setGames() {
        let s = [...Array(32)].map((_, i) => document.getElementById("player" + (i + 1)).innerHTML = '')
        let availablePlayers = players.filter(player => player[4])
        players = players.map(player => setPlayersPlayed(player, availablePlayers))
        setCaptains()
        let courtsAvailable = document.getElementById("courtsAvailable").value || 4;
        if (parseInt(courtsAvailable) > 8) {
            courtsAvailable = 8
            document.getElementById("courtsAvailable").value = 8
        }

        let t = [...Array(8)].map((_, i) => document.getElementById("court" + (i + 1)).style.display = "none")
        if (document.getElementById('graded').checked) {
            setGamesGraded(availablePlayers, courtsAvailable)
        } else {
            setGamesStandard(availablePlayers, courtsAvailable)
        }
        let u = [...Array(parseInt(courtsAvailable))].map((_, i) => document.getElementById("court" + (i + 1)).style.display = "block")
    }

    function shiftArrayToRight(arr, places) {
        for (let i = 0; i < places; i++) {
            arr.unshift(arr.pop());
        }
        return arr
    }


    function getPlayersLeastPlayed(playersArray, allowedPlayers) {
        const sortedCaptains = Object.keys(captained).filter(captain => allowedPlayers.includes(captain)).sort(function(a, b) { return captained[a] - captained[b] || Math.random() - Math.random() }).splice(0, 4)

        let captainTeams = {}
        for (let captain of sortedCaptains) {
            captainTeams[captain] = []
        }
        let alreadySet = []
        playersArray.map(player => {

            if (!alreadySet.includes(player[0]) && sortedCaptains.includes(player[0])) {
                alreadySet.push(player[0])
                captained[player[0]] = player[0] in captained ? captained[player[0]] + 1 : 1
                const sortedPlayers = Object.keys(player[5]).sort(function(a, b) { return player[5][a] - player[5][b] || Math.random() - Math.random() })
                let addedCount = 0
                sortedPlayers.map(next => {
                    if (!alreadySet.includes(next) && !sortedCaptains.includes(next) && allowedPlayers.includes(next) && addedCount < 3) {
                        alreadySet.push(next)
                        captainTeams[player[0]].push(next)
                        addedCount += 1
                    }
                })
            }
        })
        let finalSet = []
        Object.keys(captainTeams).map(captain => {
            finalSet.push(captain)
            finalSet = finalSet.concat(captainTeams[captain])
        })
        return [...new Set(finalSet)]
    }

    function setGamesStandard(availablePlayers, courtsAvailable, matchStartCount = 1, performShuffle = true, maxCount = null) {
        var MAX = 3;
        var rand = Math.floor((Math.random() * MAX) + 1);
        console.log(rand)
        if (rand == 2) {
            console.log("resetting players")
            resetPlayers();
        } else {
            const availablePlayersNames = availablePlayers.map(player => player[0])

            let maxPlayers = Math.floor(availablePlayers.length / 4) * 4;
            if (maxPlayers > courtsAvailable * 4) maxPlayers = courtsAvailable * 4
            if (maxCount) maxPlayers = maxCount
            availablePlayers = availablePlayers.sort(comparePlayCounts)
            let playersForGames = availablePlayers.filter(player => player[3] === 'Waiting').map(player => player[0]);
            if (playersForGames.length < maxPlayers) {
                playersForGames = playersForGames.concat(
                    getNext(availablePlayers.filter(player => !playersForGames.includes(player[0])))
                    .slice(0, maxPlayers - playersForGames.length)
                    .map(player => player[0]))
            }

            courts = [
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                []
            ]
            playersForGames = playersForGames.slice(0, maxPlayers);
            if (performShuffle) {
                playersForGames = shuffle(playersForGames);
                playersForGames = getPlayersLeastPlayed(players.filter(player => playersForGames.includes(player[0])), playersForGames)
            }
            current_court = 0;

            playersForGames.map((player, index) => {
                if (index != 0 && index % 4 === 0) {
                    current_court += 1
                }
                courts[current_court].push(player)
                document.getElementById("player" + (index + matchStartCount)).innerHTML = `<h4><button style="margin-right: 10px; border: 1px solid lightgrey; padding: 5px 10px; padding-bottom: 30px; box-shadow: 3px 3px 3px lightgrey; background-color: white; height: 30px;" onclick="markWinner('${player}')">Win</button>${player}</h4>`
            })


            players = players.map(player => {
                if (availablePlayersNames.includes(player[0])) {
                    player[3] = playersForGames.includes(player[0]) ? 'Playing' : 'Waiting'
                    player[2] = playersForGames.includes(player[0]) ? player[2] + 1 : player[2]
                    for (let court of courts) {
                        if (court.includes(player[0])) {
                            for (let other of court) {
                                if (other === player[0]) continue
                                player[5][other] = other in player[5] ? player[5][other] + 1 : 1
                            }
                        }
                    }
                }
                return player
            })
            setTable()
        }

    }

    function chunkArray(arr, n) {
        const size = Math.round(arr.length / n);
        return Array.from({ length: n }, (v, i) =>
            arr.slice(i * size, i * size + size)
        );
    }

    function setGamesGraded(availablePlayers, courtsAvailable) {

        let courts = []
        let secondaryCourts = []

        let courtDivision = Math.floor(courtsAvailable % 2) == 0 && courtsAvailable > 2 ? Math.floor(courtsAvailable / 2) : parseInt(courtsAvailable)

        while (courts.length < courtDivision) {
            courts.push([])
            secondaryCourts.push([])
        }
        availablePlayers = availablePlayers.sort(compareDivisions)

        let seenNames = []

        const firstPromise = new Promise((resolve, reject) => {
            let courtIndex = 0
            courts = chunkArray(availablePlayers.filter(player => player[3] === 'Waiting'), courtDivision)
            resolve("")
        })
        firstPromise.then((ret) => {
            const secondPromise = new Promise((resolve, reject) => {
                secondaryCourts = chunkArray(availablePlayers.filter(player => player[3] !== 'Waiting'), courtDivision)
                console.log(secondaryCourts.length)
                courts = courts.map((court, index) => {
                    court = court.concat(secondaryCourts[index])
                    return court
                })
                resolve("")
            }).then(resp => {
                let currentCourt = 1
                const maxCount = courtDivision < courtsAvailable ? (currentCourt + 4 * courtDivision) - 1 : 4
                for (let court of courts) {
                    if (court.length < 4) continue
                    setGamesStandard(court, courtsAvailable, currentCourt, false, maxCount)
                    currentCourt += courtDivision < courtsAvailable ? 4 * courtDivision : 4
                }

            })

        })

    }

    function setGamesGradedOld(availablePlayers, courtsAvailable) {
        let maxPlayers = Math.floor(availablePlayers.length / 4) * 4;
        if (maxPlayers > courtsAvailable * 4) maxPlayers = courtsAvailable * 4
        availablePlayers = availablePlayers.sort(compareDivisions)
        let grades = { "1": [], "2": [], "3": [], "4": [], "5": [], "6": [], "7": [], "8": [], "9": [], "10": [], "11": [] }

        let lastDivision = parseInt(availablePlayers[0][1])
        const playerCount = availablePlayers.length

        let maxPlayersPerGroup = playerCount / courtsAvailable > 4 ? (playerCount / courtsAvailable) + Math.floor(playerCount % courtsAvailable) : 4

        if (playerCount / maxPlayersPerGroup < 4) {
            maxPlayersPerGroup = Math.floor(playerCount / 4)
        }
        availablePlayers.map(player => {
            let division = player[1]
            if (grades[lastDivision].length < maxPlayersPerGroup) {
                grades[lastDivision].push(player)
            } else if (grades[player[1]].length >= maxPlayersPerGroup) {
                grades[parseInt(player[1]) + 1].push(player)
            } else {
                grades[parseInt(player[1])].push(player)
            }
        })
        let currentCourt = 1
        lastDivision = parseInt(availablePlayers[0][1])
        Object.values(grades).map((division, index) => {
            grades[index] = division.sort(comparePlayCounts)
        })
        Object.values(grades).map((division, index) => {
            if (index > 1 && index < grades.length) {
                if (grades[index + 1].length > 0 && grades[lastDivision].length < maxPlayersPerGroup && grades[lastDivision].length <= 4 + Math.floor(playerCount % courtsAvailable)) {

                    while (grades[lastDivision].length < 4 + (playerCount % courtsAvailable) && grades[index + 1].length > 0) {
                        grades[lastDivision].push(grades[index + 1].shift())
                    }
                    if (grades[index + 1].length > 0) lastDivision = index + 1
                } else {
                    lastDivision = index + 1
                }
            }
        })
        for (let division of Object.values(grades)) {
            if (division.length == 0) continue
            setGamesStandard(division, courtsAvailable, currentCourt, false)
            currentCourt += 4
        }
        // setTable()
    }

    function getNext(array) {
        return array.sort(comparePlayCounts)

    }

    function shuffle(array) {
        array = array.map(value => ({ value, sort: Math.random() }))
            .sort((a, b) => a.sort - b.sort)
            .map(({ value }) => value)


        return array;
    }


    function setTable() {
        document.getElementById("tableRows").innerHTML = ""
        document.getElementById("tableRowsAttending").innerHTML = ""
        window.localStorage.setItem('players', JSON.stringify(players))
        let playerRows = ''
        let playerRowsAttending = ''
        players.sort((a, b) => a[0].localeCompare(b[0])).map((player, index) => {
            if (player[4]) {
                playerRowsAttending += `<tr><td><span class="hover" style="border: 1px solid lightgrey; padding: 5px 10px; box-shadow: 3px 3px 3px lightgrey;" onclick="toggleAttending(${index})">Set Not Attending</span></td><td>${player[0]}</td><td><button style="margin-right: 10px; border: 1px solid lightgrey; padding: 5px 10px; box-shadow: 3px 3px 3px lightgrey; background-color: white; height: 30px;" onclick="decrementPlayCount(${index})">-</button>${player[2]}<button style="margin-left: 10px; border: 1px solid lightgrey; padding: 5px 10px; box-shadow: 3px 3px 3px lightgrey; background-color: white; height: 30px;" onclick="incrementPlayCount(${index})">+</button></td><td>${player[6]}</td><td>${player[1]}</td><td>${player[3]}</td><td><button style="margin-right: 10px; border: 1px solid lightgrey; padding: 5px 10px; box-shadow: 3px 3px 3px lightgrey; background-color: white; height: 30px;" onclick="togglePlaying(${index})">Toggle Playing</button></td></tr>`
            } else {
                playerRows += `<tr><td><span class="hover" style="border: 1px solid lightgrey; padding: 5px 10px; box-shadow: 3px 3px 3px lightgrey;" onclick="toggleAttending(${index})">Set Attending</span></td><td>${player[0]}</td><td>${player[2]}</td><td>${player[1]}</td><td>${player[3]}</td></tr>`
            }
        })

        document.getElementById("tableRows").innerHTML = playerRows
        document.getElementById("tableRowsAttending").innerHTML = playerRowsAttending
    }

    function toggleAttending(index) {
        players[index][4] = !players[index][4]
        setTable()
    }

    function decrementPlayCount(index) {
        players[index][2] = players[index][2] > 0 ? players[index][2] - 1 : 0
        setTable()
    }

    function incrementPlayCount(index) {
        players[index][2] = players[index][2] + 1
        setTable()
    }

    function togglePlaying(index) {
        if (players[index][3] === "Playing") {
            players[index][3] = "Waiting"
            decrementPlayCount(index)
        } else {
            players[index][3] = "Playing"
            incrementPlayCount(index)
        }
    }

    function markWinner(name) {
        players = players.map(player => {
            if (player[0] === name) {
                player[6] += 1
            }
            return player
        })
        setTable()
    }

    function processForm(e) {
        if (e.preventDefault) e.preventDefault();

        const playerName = document.getElementById("newPlayer").value;
        const playerDivision = parseFloat(document.getElementById("newPlayerDivision").value);
        if (playerName && playerDivision) {
            document.getElementById("newPlayer").value = null;
            document.getElementById("newPlayerDivision").value = null;
            document.getElementById("formWarning").innerHTML = "";
            players.push([playerName, playerDivision, 0, 'Waiting', true, {}, 0])
        } else {
            document.getElementById("formWarning").innerHTML = "Please add player name and division";
        }

        setTable()

        return false;
    }

    const form = document.getElementById('playerInputForm');
    if (form.attachEvent) {
        form.attachEvent("submit", processForm);
    } else {
        form.addEventListener("submit", processForm);
    }

    const fileInput = document.getElementById('csv')
    const readFile = () => {
        const reader = new FileReader()
        reader.onload = () => {
            playsers = []
            Promise.all(reader.result.split('ï»¿').join('').split('\r').join('').split('\n').map(row => {
                let player = row.split(',')
                if (player.length > 1) {
                    players.push([player[0], parseFloat(player[1]), 0, 'Waiting', false, {}, 0])
                }
            })).then(setTable())

        }
        reader.readAsBinaryString(fileInput.files[0])
    }

    fileInput.addEventListener('change', readFile)
    </script>
</body>

</html>